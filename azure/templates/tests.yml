parameters:
    - name: service_name
      type: string

steps:
    - bash: |
          make -C e2e install
      workingDirectory: $(SERVICE_DIR)
      displayName: Setup e2e tests

    - bash: |
        export RELEASE_RELEASEID=$(Build.BuildId)
        export SOURCE_COMMIT_ID=$(Build.SourceVersion)
        export APIGEE_ENVIRONMENT="$(APIGEE_ENVIRONMENT)"
        export SERVICE_BASE_PATH="$(SERVICE_BASE_PATH)"
        make -C e2e coverage

      workingDirectory: $(SERVICE_DIR)
      displayName: 'Run e2e Tests'

    - task: PublishTestResults@2
      displayName: 'Publish e2e Test Results'
      inputs:
          testResultsFiles: |
              $(SERVICE_DIR)/reports/e2e.xml
          failTaskOnFailedTests: true
